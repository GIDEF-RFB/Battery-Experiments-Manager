version: '3.8'

name: wattrex_mn_prod

services:
  wattrex_db:
    image: mysql:8.0.31-debian
    container_name: wattrex_master_db
    restart: always
    ports:
      - "3322:3306"
    volumes:
      - wattrex_db_data_prod:/var/lib/mysql
      - ./createMasterCyclerTables.sql:/docker-entrypoint-initdb.d/createMasterCyclerTables.sql
      - ./insertDeviceInfoToMaster.sql:/docker-entrypoint-initdb.d/insertDeviceInfoToMaster.sql
    env_file:
      - .cred.env

  wattrex_mn_manager:
    build:
      context: ../
      dockerfile: ./devops/Dockerfile.mn_manager
    image: wattrex-mn-manager:0.0.1
    container_name: wattrex_mn_manager
    restart: always
    ipc: host
    volumes:
      - ./mn_manager/log_config.yaml:/code/devops/mn_manager/log_config.yaml
      - ./mn_manager/.cred.yaml:/code/devops/mn_manager/.cred.yaml
    env_file:
      - .cred.env
    depends_on:
      - wattrex_db

  wattrex_web_server:
    build:
      context: ../
      dockerfile: ./devops/Dockerfile.web_server
    image: wattrex-web-server:0.0.2
    container_name: wattrex_web_server
    restart: always
    ports:
      - "8811:8000"
    ipc: host
    volumes:
      - ../static/images:/code/static/images                                     # Linked to store graph images
      - ./mn_manager/log_config.yaml:/code/log_config.yaml
    env_file:
      - .cred.env
    depends_on:
      - wattrex_db
      - wattrex_mn_manager


volumes:
  wattrex_db_data_prod:
    name: wattrex_db_data_prod
