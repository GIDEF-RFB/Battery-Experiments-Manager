{% extends "base.html" %}
{% load static %}


{% block page_content %}
    <style>
        .filter-select {
            margin-bottom: 10px;
        }

        td, th {
            text-align: center;
        }

        .svg-icon-table {
            height: 2.33em;
            vertical-align: middle;
            fill: currentColor;
            overflow: hidden;
        }

        .svg-icon-table-chart {
            height: 2em;
            vertical-align: middle;
            fill: currentColor;
            overflow: hidden;
        }

        button#btnClearFilters:has(> div) {
            display: flow-root;
        }

        button#btnClearFilters {
            /* margin-bottom: 15px; */
            /* border-color: #9faab4; */
            padding: 0em;
            float: right;
        }

        button#btnClearFilters > svg {
            /* width: 3em; */
            height: 2em;
            overflow: hidden;
            fill: #AAAAAA;
            stroke: #888;
        }

        button#btnClearFilters:hover > svg{
            /* color: #000;
            background-color: #e9ecef !important;
            border-color: #6c757d; */
	        -webkit-animation: rotate-center 0.6s cubic-bezier(0.600, -0.280, 0.735, 0.045) reverse both;
	        animation: rotate-center 0.6s cubic-bezier(0.600, -0.280, 0.735, 0.045) reverse both;
        }

        /* ----------------------------------------------
        * Generated by Animista on 2023-7-20 11:14:42
        * Licensed under FreeBSD License.
        * See http://animista.net/license for more info. 
        * w: http://animista.net, t: @cssanimista
        * ---------------------------------------------- */

        /**
        * ----------------------------------------
        * animation rotate-center
        * ----------------------------------------
        */
        @-webkit-keyframes rotate-center {
        0% {
            -webkit-transform: rotate(0);
                    transform: rotate(0);
        }
        100% {
            -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
        }
        }
        @keyframes rotate-center {
        0% {
            -webkit-transform: rotate(0);
                    transform: rotate(0);
        }
        100% {
            -webkit-transform: rotate(360deg);
                    transform: rotate(360deg);
        }
        }


    </style>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="bg-light experimentsMainPanel ">
                    <div class="row">
                        <div class="col-xl-3 col-md-6 col-12 filter-select">
                            <!-- TECHNOLOGY SELECT -->
                            <label for="expBattery">Technology&nbsp;&nbsp;</label>
                            <select name="technology_select" id="technology_select" class=".selectpicker" data-live-search="true" data-size="8" data-title="Select Technology..." multiple data-actions-box="true">
                                {% for tech in technology_list %}
                                    <option data-tokens="{{ tech }}" value="{{ tech }}" label="{{ tech }}">{{ tech }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-xl-3 col-md-6 col-12 filter-select">
                            <!-- BATTERY SELECT -->
                            <label for="battery_select">Battery&nbsp;&nbsp;</label>
                            <select name="battery_select" id="battery_select" class=".selectpicker" data-live-search="true" data-size="8" data-title="Select Battery..." multiple data-actions-box="true" required>
                                {% for battery in battery_list %}
                                    <option data-tokens="{{ battery.tech }}" value="{{ battery.bat_id }}" label="{{ battery.tech }}">{{ battery.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-xl-3 col-md-6 col-12 filter-select">
                            <!-- STATION SELECT -->
                            <label for="cycle_station_select">Station&nbsp;&nbsp;</label>
                            <select name="cycle_station_select" id="cycle_station_select" class=".selectpicker" data-live-search="true" data-size="8" data-title="Select Station..." multiple data-actions-box="true" required>
                                {% for cycle_station in cycle_station_list %}
                                    <option data-tokens="{{ cycle_station.name }}" value="{{ cycle_station.cs_id }}" label="{{ cycle_station.name }}">{{ cycle_station.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-xl-3 col-md-6 col-12 filter-select">
                            <!-- PROFILE SELECT -->
                            <label for="profile_select">Profile&nbsp;&nbsp;</label>
                            <select name="profile_select" id="profile_select" class=".selectpicker" data-live-search="true" data-size="8" data-title="Select Profile..." multiple data-actions-box="true" required>
                                {% for profile in profile_list %}
                                    <option data-tokens="{{ profile.name }}" value="{{ profile.prof_id }}" label="{{ profile.name }}">{{ profile.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-light btn-sm" id="btnClearFilters">
                                <svg
                                viewBox="0 0 29.120699 29.641628"
                                version="1.1"
                                id="svg5"
                                xmlns="http://www.w3.org/2000/svg"
                                xmlns:svg="http://www.w3.org/2000/svg">
                                    <defs
                                        id="defs2" />
                                    <g
                                        id="layer1"
                                        transform="translate(-12.56504,-10.465559)">
                                        <path
                                        d="m 26.30683,10.465568 c -7.58763,0 -13.74179,6.154163 -13.74179,13.741796 0,4.412421 2.08151,8.337777 5.31647,10.847918 l -2.90215,2.819467 9.525,0.08268 0.19844,-9.525001 -3.00964,2.918684 c -2.34259,-1.515011 -3.89434,-4.145286 -3.89434,-7.14375 0,-4.699803 3.80821,-8.508007 8.50801,-8.508007 0.20627,0 0.40927,0.01038 0.61185,0.0248 v -5.242056 c -0.20188,-0.0088 -0.4078,-0.01654 -0.61185,-0.01654 z m 3.439585,2.149739 -0.198438,9.525 3.009636,-2.918685 c 2.342592,1.515012 3.894336,4.145287 3.894336,7.14375 0,4.699803 -3.808204,8.508009 -8.508009,8.508009 -0.20626,0 -0.40926,-0.01037 -0.61185,-0.02479 v 5.242057 c 0.20188,0.0088 0.40781,0.01654 0.61185,0.01654 7.587635,0 13.741798,-6.154165 13.741798,-13.741799 0,-4.41242 -2.081514,-8.337776 -5.316471,-10.847916 l 2.902148,-2.819466 -9.525,-0.08268 z"
                                        id="path17"
                                        style="stroke-width:0.264583" />
                                    </g>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <table id="experimentsTable" class="table table-bordered">
                                <thead class="thead-light">
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Description</th>
                                    <th scope="col">Date Begin</th>
                                    <th scope="col">Date Finish</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Preview</th>
                                    <th scope="col">Data</th>
                                    <th scope="col">Report</th>
                                    <th scope="col">Status_Int_Order</th>
                                </tr>
                                </thead>
                                <tbody>

                                {% for experiment, cs_id_name, batteryName, profileName in experiments_list %}
                                <tr>
                                    <td style="vertical-align: middle">{{ experiment.exp_id }}</td>
                                    <td style="vertical-align: middle">{{ experiment.name }}</td>
                                    <td style="max-width: 400px; overflow: auto;">{{ experiment.description }}</td>
                                    <td style="vertical-align: middle">{% if experiment.date_begin %}{{ experiment.date_begin|date:"Y/m/d H:i:s" }}{% else %}--{% endif %}</td>
                                    <td style="vertical-align: middle">{% if experiment.date_finish %}{{ experiment.date_finish|date:"Y/m/d H:i:s" }}{% else %}--{% endif %}</td>
                                    <td style="vertical-align: middle"
                                            {% if experiment.status == 'QUEUED' %}
                                        class="table-warning"
                                            {% elif experiment.status == 'RUNNING' %}
                                        class="table-success"
                                            {% elif experiment.status == 'FINISHED' %}
                                        class="table-primary"
                                            {% elif experiment.status == 'PAUSED' %}
                                        class="table-secondary"
                                            {% else %}
                                        class="table-danger"
                                            {% endif %}>
                                        {{ experiment.status }}
                                    </td>
                                    {% if experiment.status == 'FINISHED' or experiment.status == 'ERROR' %}
                                    <td class="_tooltip" style="vertical-align: middle">
                                        <span class="_tooltiptext"><img class="lazy" data-src="{% static 'images/graph_preview' %}/exp_{{ experiment.exp_id }}.webp" alt="graph preview" width="600" height="400" onerror="this.src='{% static 'images/graph_not_found.jpg' %}'"></span>
                                        <a href="/preview{{ experiment.exp_id }}/">{% include 'chart.svg' %}</a>
                                    </td>
                                    {% else %}
                                    <td class="_tooltip" style="vertical-align: middle">
                                        <span class="_tooltiptext" style="">Preview image only available in FINISHED or ERROR experiments</span>
                                        <a href="/preview{{ experiment.exp_id }}/">{% include 'chart.svg' %}</a>
                                    </td>
                                    {% endif %}
                                    <td style="vertical-align: middle">
                                        <a href="/csv{{ experiment.exp_id }}/">{% include 'csv.svg' %}</a>
                                    </td>
                                    <td style="vertical-align: middle">
                                        <a href="/report{{ experiment.exp_id }}">{% include 'pdf.svg' %}</a>
                                    </td>
                                {% if experiment.status == 'QUEUED' %}
                                    <td>1</td>
                                {% elif experiment.status == 'RUNNING' or experiment.status == 'PAUSED' %}
                                    <td>2</td>
                                {% elif experiment.status == 'FINISHED' %}
                                    <td>3</td>
                                {% else %}
                                    <td>4</td>
                                {% endif %}

                                </tr>

                                {% endfor %}
                                
                                </tbody>
                            </table>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="{% static 'DataTables/datatables.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap-select/js/bootstrap-select.min.js'%}"></script>
    <script>
        
        var technology_select = $('#technology_select').selectpicker();
        var battery_select = $('#battery_select').selectpicker();
        var cycle_station_select = $('#cycle_station_select').selectpicker();
        var profile_select = $('#profile_select').selectpicker();

        technology_select.on('hide.bs.select', function (e) {
            updateFilters(e.target.id);
        });
        battery_select.on('hide.bs.select', function (e) {
            updateFilters(e.target.id);
        });
        cycle_station_select.on('hide.bs.select', function (e) {
            updateFilters(e.target.id);
        });
        profile_select.on('hide.bs.select', function (e) {
            updateFilters(e.target.id);
        });

        $('#btnClearFilters').on('click', function () {
            $('#technology_select').selectpicker('deselectAll');
            $('#battery_select').selectpicker('deselectAll');
            $('#cycle_station_select').selectpicker('deselectAll');
            $('#profile_select').selectpicker('deselectAll');
            
            updateFilters('reset_select');
        });
    </script>
    
    <script>
        function lazy_config(){
            $('._tooltip').on('mouseenter', function(element){
                let child_img = $(element.currentTarget).find('img');
                if (child_img.attr('data-src')) {
                    child_img.attr('src', child_img.attr('data-src'));
                    child_img.removeAttr('data-src');
                    // console.log('done')
                }
            });
        }

        window.onload = (event) => {
            let table = $('#experimentsTable').DataTable({
                "columnDefs": [
                    // {#{"targets": 'no-sort', "orderable": false, }#}
                    {"orderable": false, "targets": 2},
                    {"orderData": 9, "targets": 5},
                    {"visible": false, "targets": 9}
                ],
                "order": [5, "asc"],
                "moment":('YYYY.MM.DD hh:mm:ss a'),
            });

            table.on('draw', function(){
                lazy_config();
            });

            table.draw();
        };
    </script>

    <script>
        const chart_svg = '{% include "chart.svg" %}';
        const csv_svg = '{% include "csv.svg" %}';
        const pdf_svg = '{% include "pdf.svg" %}';

        class Experiment {
            constructor(id, name, description, date_begin, date_finish, status) {
                this.id = id;
                this.name = name;
                this.description = description;
                if (date_begin) {
                    this.date_begin = date_begin;
                }
                else {
                    this.date_begin = "--";
                }
                if (date_finish) {
                    this.date_finish = date_finish;
                }
                else {
                    this.date_finish = "--";
                }
                this.status = status;
                let img_preview = false; 
                if (status == "QUEUED") {
                    this.status_int_order = 1;
                } else if (status == "RUNNING" || status == "PAUSED") {
                    this.status_int_order = 2;
                } else if (status == "FINISHED") {
                    this.status_int_order = 3;
                    img_preview = true;
                } else {
                    this.status_int_order = 4;
                    img_preview = true;
                }
                if (img_preview) {
                    this.preview = '<span class="_tooltiptext"><img class="lazy" data-src="{% static 'images/graph_preview' %}/exp_' + id + '.webp" alt="graph preview" width="600" height="400"  onerror="this.src=' + '{% static 'images/graph_not_found.jpg' %}' + '"></span><a href="/preview' + id + '/">' + chart_svg + '</a>';
                }
                else {
                    this.preview = '<span class="_tooltiptext">Preview image only available in FINISHED or ERROR experiments</span><a href="/preview' + id + '/">' + chart_svg + '</a>';
                }
                this.data = '<a href="/csv' + id + '/">' + csv_svg + '</a>';    //TODO: Change to AJAX request with Loading/Downloading spinner https://stackoverflow.com/questions/4684722/show-loading-image-while-ajax-is-performed
                this.report = '<a href="/report' + id + '/">' + pdf_svg + '</a>';
            }

            to_array() {
                return [this.id, this.name, this.description, this.date_begin, this.date_finish, this.status, this.preview, this.data, this.report, this.status_int_order];
            }
        }

        function updateFilters( target_name ) {
            // console.log(target_name)
            $.ajax({
                async: false,
                type: "POST",
                url: "{% url 'apply-experiments-filters' %}",   
                // contentType: "application/json; charset=utf-8",
                data: {csrfmiddlewaretoken: '{{ csrf_token }}',
                        input_select: target_name,
                        filters_technology: JSON.stringify($('#technology_select').val()),
                        filters_battery: JSON.stringify($('#battery_select').val()),
                        filters_cycle_station: JSON.stringify($('#cycle_station_select').val()),
                        filters_profile: JSON.stringify($('#profile_select').val()),
                    },
                success:  function(response){
                    reloadExperimentsTable(JSON.parse(response)['experiment_list']);
                    updateOptions('battery_select', JSON.parse(response)['bats']);
                    updateOptions('cycle_station_select', JSON.parse(response)['stations']);
                    updateOptions('profile_select', JSON.parse(response)['profs']);
                    reloadExperimentsTable(JSON.parse(response)['experiment_list']);
                }
            });
        }
        
        function reloadExperimentsTable(experiment_list) {
            let table = $('#experimentsTable').DataTable();
            table.clear().draw();

            
            for (experiment of experiment_list) {

                let class_to_add = "";
                switch (experiment['status']) {
                    case 'FINISHED':
                        class_to_add = 'table-primary'
                        break;
                    case 'RUNNING':
                        class_to_add = 'table-success'
                        break;
                    case 'PAUSED':
                        class_to_add = 'table-secondary'
                        break;
                    case 'QUEUED':
                        class_to_add = 'table-warning'
                        break;
                    case 'ERROR':
                        class_to_add = 'table-danger'
                        break;
                    default:
                        break;
                }

                let add_row = table.row.add(new Experiment(
                    experiment['id'], 
                    experiment['name'], 
                    experiment['description'], 
                    experiment['date_begin'], 
                    experiment['date_finish'],
                    experiment['status'],
                ).to_array());
                
                add_row.node().cells[6].classList.add('_tooltip');
                add_row.node().cells[5].classList.add(class_to_add);
            }

            table.draw();
        }

        function updateOptions(select_id, items_list) {
            // console.log(select_id)
            // console.log(items_list)

            $('#' + select_id + ' option').each(function() {
                // console.log($(this).val())
                if (items_list.includes(Number($(this).val()))) {
                    $(this).prop('disabled', false);
                    // console.log($(this).val())
                    
                } else {
                    $(this).prop('disabled', true);
                    // console.log('no')
                }
            });

            // console.log($('#' + select_id + ' option'))
            // console.log('#' + select_id + ' -> ' + items_list[0]);

            // $('#technology_select').append(new Option("option text", "value"));
            $('#' + select_id).selectpicker('refresh');
        }

        
    </script>


    
{% endblock %}